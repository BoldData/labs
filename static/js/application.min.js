var color_domain=d3.scale.category20c();var color=d3.scale.ordinal().domain(["pjd","ind","rni","pps","mp"]).range([color_domain(0),color_domain(19),color_domain(8),color_domain(12),color_domain(16)]);var mapParty=function(color){switch(color){case"pjd":return"Parti Politique : Parti de la justice et du développement";case"rni":return"Parti Politique : Rassemblement national des indépendants";case"mp":return"Parti Politique : Mouvement populaire";case"pps":return"Parti Politique : Parti du progrès et du socialisme";default:return""}};var mapPartyLegend=function(color){switch(color){case"pjd":return"Parti de la justice et du développement";case"rni":return"Rassemblement national des indépendants";case"mp":return"Mouvement populaire";case"pps":return"Parti du progrès et du socialisme";default:return"Indépendant"}};var w=960-80,h=600-180,x=d3.scale.linear().range([0,w]),y=d3.scale.linear().range([0,h]),color=color,root,node;var legendRectSize=20;var legendSpacing=10;var zero=d3.format(",d");var mousemove=function(d){var xPosition=d3.event.pageX+5;var yPosition=d3.event.pageY-5;d3.select("#tooltip").style("left",xPosition+"px").style("top",yPosition+"px");d3.select("#tooltip #heading").text(d.name);d3.select("#tooltip #value").text("Budget 2016 : "+zero(d.value)+" MAD");d3.select("#tooltip #party").text(mapParty(d.color));d3.select("#tooltip").classed("hidden",false)};var mouseout=function(){d3.select("#tooltip").classed("hidden",true)};var treemap=d3.layout.treemap().round(false).size([w,h]).sticky(true).value(function(d){return d.size});var svg=d3.select("#body").append("div").attr("class","chart mdl-cell mdl-cell--9-col mdl-cell--6-col-tablet mdl-cell--3-col-phone").style("width","auto").style("height",h+"px").append("svg:svg").attr("width",w).attr("height",h).append("svg:g").attr("transform","translate(.5,.5)");var insertLinebreaks=function(d){var el=d3.select(this);var words=d.name.split(" ");el.text("");for(var i=0;i<words.length;i++){var tspan=el.append("tspan").text(words[i]);if(i>0)tspan.attr("x",0).attr("dy","15")}};d3.json("../budgetfinances2016.json",function(data){node=root=data;var nodes=treemap.nodes(root).filter(function(d){return!d.children});var cell=svg.selectAll("g").data(nodes).enter().append("svg:g").attr("class","cell").attr("transform",function(d){return"translate("+d.x+","+d.y+")"}).on("mousemove",mousemove).on("mouseout",mouseout).on("click",function(d){return zoom(node==d.parent?root:d.parent)});cell.append("svg:rect").attr("width",function(d){return d.dx-1}).attr("height",function(d){return d.dy-1}).style("fill",function(d){return color(d.parent.name)});cell.append("svg:text").attr("x",function(d){return d.dx/2}).attr("y",function(d){return d.dy/2}).attr("dy",".35em").attr("text-anchor","middle").text(function(d){return d.name}).style("opacity",function(d){d.w=this.getComputedTextLength();return d.dx>d.w?1:0});var legend=d3.select("#legend").append("svg").selectAll("g").data(color.domain()).enter().append("g").attr("transform",function(d,i){var height=legendRectSize;var x=0;var y=i*height;return"translate("+x+","+y+")"});legend.append("rect").attr("width",legendRectSize).attr("height",legendRectSize).style("fill",color).style("stroke",color);legend.append("text").attr("x",legendRectSize+legendSpacing).attr("y",legendRectSize-legendSpacing).text(function(d){return mapPartyLegend(d)});d3.select("#zoomout").on("click",function(){zoom(root)});d3.select(window).on("click",function(){zoom(root)});d3.select("select").on("change",function(){treemap.value(this.value=="size"?size:count).nodes(root);zoom(node)})});function size(d){return d.size}function count(d){return 1}function zoom(d){var kx=w/d.dx,ky=h/d.dy;x.domain([d.x,d.x+d.dx]);y.domain([d.y,d.y+d.dy]);var t=svg.selectAll("g.cell").transition().duration(d3.event.altKey?7500:750).attr("transform",function(d){return"translate("+x(d.x)+","+y(d.y)+")"});t.select("rect").attr("width",function(d){return kx*d.dx-1}).attr("height",function(d){return ky*d.dy-1});t.select("text").attr("x",function(d){return kx*d.dx/2}).attr("y",function(d){return ky*d.dy/2}).style("opacity",function(d){return kx*d.dx>d.w?1:0});node=d;d3.event.stopPropagation()}var politicalPartyChart=dc.rowChart("#political-party-chart");var yearChart=dc.pieChart("#year-chart");var ministryChart=dc.rowChart("#ministry-chart");var tableChart=dc.dataTable("#table-chart");d3.json("dcdata.json",function(data){var parseDate=d3.time.format("%Y");si=d3.format("s");siMod=function(val){return si(val).replace(/M/," MDH").replace(/G/," MMDH")};data.forEach(function(d){d.yearly=d.year;d.value=d.value;d.ministry=d.Ordonnateur});var ndx=crossfilter(data);var all=ndx.groupAll();var yearlyDimension=ndx.dimension(function(d){return d.year});var yearlyGroup=yearlyDimension.group().reduceSum(function(d){return d.value});var politicalPartyDimension=ndx.dimension(function(d){switch(d.party){case"pjd":return"Parti de la justice et du développement";case"rni":return"Rassemblement national des indépendants";case"mp":return"Mouvement populaire";case"pps":return"Parti du progrès et du socialisme";case"ind":return"Indépendant";default:return""}});var mapPartyLegend=function(_id_){switch(_id_){case"pjd":return"Parti de la justice et du développement";case"rni":return"Rassemblement national des indépendants";case"mp":return"Mouvement populaire";case"pps":return"Parti du progrès et du socialisme";default:return"Indépendant"}};var politicalPartyGroup=politicalPartyDimension.group().reduceSum(function(d){return d.value});var ministryDimension=ndx.dimension(function(d){return d.ministry});var ministryGroup=ministryDimension.group().reduceSum(function(d){return d.value});yearChart.width(400).height(300).radius(100).innerRadius(30).dimension(yearlyDimension).title(function(d){return"Budget : "+siMod(d.value)}).group(yearlyGroup);ministryChart.width(400).height(300).margins({top:20,left:10,right:10,bottom:20}).group(ministryGroup).dimension(ministryDimension).label(function(d){return d.key}).title(function(d){return"Budget : "+siMod(d.value)}).data(function(group){return group.top(10)}).elasticX(true).xAxis().ticks(4).tickFormat(siMod);politicalPartyChart.width(400).height(300).margins({top:20,left:10,right:10,bottom:20}).group(politicalPartyGroup).dimension(politicalPartyDimension).label(function(d){return d.key}).title(function(d){return"Budget : "+siMod(d.value)}).elasticX(true).xAxis().ticks(4).tickFormat(siMod);tableChart.dimension(yearlyDimension).group(function(d){return d.year}).columns([function(d){return d.year},function(d){return d.ministry},function(d){return mapPartyLegend(d.party)},function(d){return siMod(d.value)}]).sortBy(function(d){return d.year}).order(d3.descending);dc.renderAll()});